# CodeWithDanko 認證服務架構

## 概述

本文檔描述了 CodeWithDanko 應用的認證服務架構。該架構採用了集中式服務層設計，將認證邏輯統一管理，提高了代碼的可維護性和安全性。

## 核心組件

### 1. 認證服務 (`app/lib/auth.ts`)

這是認證邏輯的核心文件，提供了以下功能：

- **類型定義**：定義了用戶、登錄請求、註冊請求等類型
- **令牌管理**：處理 JWT 令牌的存儲和獲取
- **用戶信息管理**：處理用戶信息的存儲和獲取
- **Cookie 處理**：在服務器端處理認證 Cookie
- **工具函數**：提供檢查認證狀態、從請求中獲取用戶等實用函數

### 2. API 工具 (`app/lib/api.ts`)

提供了統一的 API 請求處理：

- **服務器端請求**：使用 Cloudflare Workers 服務綁定進行 API 調用
- **客戶端請求**：使用瀏覽器 fetch API 進行 API 調用
- **錯誤處理**：統一的錯誤處理邏輯
- **令牌注入**：自動將認證令牌添加到請求頭中

### 3. React 認證 Hook (`app/lib/useAuth.tsx`)

提供了 React 應用中使用認證的工具：

- **AuthProvider**：認證上下文提供者組件
- **useAuth**：用於獲取認證狀態和操作的 Hook
- **withAuth**：用於保護路由的高階組件

## 認證流程

### 登錄流程

1. 用戶提交登錄表單
2. 服務器使用 `serverFetch` 發送登錄請求到 API
3. API 驗證憑據並返回令牌
4. 服務器將令牌存儲在 HTTP-only Cookie 中
5. 客戶端將令牌存儲在 localStorage 中
6. 用戶被重定向到儀表板

### 註冊流程

1. 用戶提交註冊表單
2. 服務器使用 `serverFetch` 發送註冊請求到 API
3. API 創建用戶並返回令牌
4. 服務器將令牌存儲在 HTTP-only Cookie 中
5. 客戶端將令牌存儲在 localStorage 中
6. 用戶被重定向到儀表板

### 登出流程

1. 用戶點擊登出按鈕
2. 服務器使用 `serverFetch` 發送登出請求到 API
3. 服務器清除認證 Cookie
4. 客戶端清除 localStorage 中的令牌和用戶信息
5. 用戶被重定向到登錄頁面

## 安全考慮

- 使用 HTTP-only Cookie 存儲令牌，防止 XSS 攻擊
- 使用 Authorization 頭傳遞令牌，遵循 JWT 最佳實踐
- 實現令牌刷新機制，減少長期令牌的安全風險

## 部署配置

- 使用環境變量配置 Cookie 域名
- 使用 Cloudflare Workers 服務綁定進行 API 調用
- 支持自定義域名部署

## 未來改進

- 實現密碼重置功能
- 添加社交登錄選項
- 實現多因素認證
- 添加用戶角色和權限管理
